name: Deploy Django to Hostinger

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Upload project to Hostinger
      uses: appleboy/scp-action@v0.1.4
      with:
        host: 45.130.228.227
        username: u844009458
        port: 65002
        key: ${{ secrets.HOSTINGER_SSH_KEY }}
        source: "./"
        target: "/home/u844009458/domains/iidmwhatsappfastapi.online/public_html/iidm-whatsapp"

    - name: Run commands on Hostinger
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 45.130.228.227
        username: u844009458
        port: 65002
        key: ${{ secrets.HOSTINGER_SSH_KEY }}
        script: |
          cd /home/u844009458/domains/iidmwhatsappfastapi.online/public_html/iidm-whatsapp

          # Create virtual environment if not exists
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi

          # Activate venv
          source venv/bin/activate

          # Upgrade pip
          pip install --upgrade pip

          # Install dependencies
          pip install -r requirements.txt

          # Create/update .env file
          echo "DEBUG=False" > .env
          echo "SECRET_KEY=your-secret-key" >> .env
          echo "DB_NAME=u844009458_whatsapp_data" >> .env
          echo "DB_USER=u844009458_eshwarvadde8" >> .env
          echo "DB_PASSWORD=eshwar9642" >> .env
          echo "DB_HOST=auth-db1235.hstgr.io" >> .env
          echo "DB_PORT=3306" >> .env

          # Run Django migrations
          python manage.py migrate

          # Restart Passenger (Hostinger Python runtime)
          touch ../tmp/restart.txt
